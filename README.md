
qgepplugin
==========

This plugin is part of the QGEP Wastewater project for QGIS.

[![Build Status](https://travis-ci.org/QGEP/qgepplugin.svg?branch=master)](https://travis-ci.org/QGEP/qgepplugin)

# QGEP-SWMM

## Installation

### Install QGEP plugin 

* Download the plugin: https://github.com/iggroup/qgepplugin/tree/swmm/src
* Save in the QGIS plugin path in a folder named `qgepplugin`.

### SWMM Installation
* Download and install [SWMM](https://www.epa.gov/water-research/storm-water-management-model-swmm)

* In QGIS `Preferences > Processing > Processing providers > QGEP > SWMM exectutable` set the path to the swmm `.exe` i.e. `C:/Program Files (x86)/EPA SWMM 5.1.013/swmm5.exe` 

### Installation psycopg2
The script requires `psycopg2` to connect to the database. (NOT SURE IF PSYCOPG IS INSTALLED BY DEFAULT WITH QGIS)

[Psycopg2 installation](https://pypi.org/project/psycopg2/)

### Installation of a postgreSQL service

In `pg_service.conf` create a service to connect to the database that you want to analyse. You can also use an existing service.

```
[pg_qgep_demo_data]
host=localhost
port=5432
dbname=qgep_demo_data
user=postgres
password=postgres
```


## QGEP - SWMM workflow

In the QGEP processing tool there are four processes:

0. `SWMM Create DB Tables` generates the table required by the plugin and fill them with the QGEP data
1. `SWMM Create Input` reads data from the table in the schema qgep_swmm and generate an input file for SWMM
2. `SWMM Execute` launches SWMM. Its likely that the the `.inp` file generated in the previous step contains error. In this case, the `.inp` file have to be opened with the SWMM Gui to solve the errors.
3. `SWMM Extract Results` parses the result file and generates three QGIS table layers. 

Then, the user has to join the computed values with the geometries and map them. This step is currently not automatised


### Create and fill SWMM tables

* Launch `SWMM Create DB Tables`
* Database: the name of the service used to connect to the database
* Path to DB Model SQL: Folder which stores the SQL files used to create the schema and swmm views, can be downloaded [here](https://github.com/tproduit/datamodel/tree/swmm_views/swmm_views)

#### Python command line
```
PGSERVICE = 'pg_qgep_demo_data'
DBMODEL = 'C:\\swmm_views'
qs = QgepSwmm(None, PGSERVICE, None, None, None, None, None, DBMODEL)
qs.create_fill_swmm_tables()
```
 
### SWMM Create Input

An `.inp` file is the input file format for SWMM. It contains the wastewater network AND simulation parameters.

The wastewater network is extracted from QGEP-SWMM tables. The simulation parameters are copied from a provided `.inp` file.

* Launch `SWMM Create Input`
* Database: the name of the service used to connect to the database
* Template INP file: a `.inp`  from which simulation parameters will be copied
* Result INP file: the `.inp`  generated from QGEP data

#### Python command line
```
TITLE = 'title simulation'
PGSERVICE = 'pg_qgep_demo_data'
INPFILE = 'C:\\qgep_swmm\\input\\qgep_swmm.inp'
INPTEMPLATE = 'C:\\qgep_swmm\\simulation_parameters\\default_qgep_swmm_parameters.inp'
qs = qgep_swmm(TITLE, PGSERVICE, INPFILE, INPTEMPLATE, None, None)
qs.write_input()
```

### SWMM Execute
The path to the SWMM executable must be set in the Processsing tools options.

* Launch `SWMM Execute`
* INP file: the `.inp`  file generated during the previous step
* LOG file: a log file generated by swmm, contains the errors.

#### Python command line

```
INPFILE = 'C:\\qgep_swmm\\input\\qgep_swmm.inp'
OUTFILE = 'C:\\\qgep_swmm\\output\\swmm.out'
LOGFILE = 'C:\\qgep_swmm\\output\\log.out'
qs = qgep_swmm(None, INPFILE, None, OUTFILE, LOGFILE, None, None)
qs.execute_swmm()
```

### SWMM Extract Results
The path to the SWMM executable must be set in the Processsing tools options.

* Launch `SWMM Extract results`
* OUT file: the `.out`  file generated during the previous step
* Node summary: a table layers which stores the simulation results.
* Link summary: a table layers which stores the simulation results.
* Cross section summary: a table layers which stores the simulation results.

### Mapping
* Use processing tool `join attributes` to add the results to the table `qgep_swmm.conduits` and `qgep_swmm.junctions`.

## Open .INP with SWMM


### I/O Error 103 
The .inp file is still open in Python. Close Python.

### Solve import errors

`Undefined Node`
The node doesn't exist in junctions, outfalls, dividers, storages

`Undefined Link`
The link doesn't exist im conduits, pumps, orifices, weirs, outlets

You have to solve the errors in the order they appear in the report. Some errors are interrelated (i.e. a node in a conduit is not defined => the conduit is not imported => Undefined link error)

## Change parameters

### Title/Notes:
* Set by the user as a QGEP_SWMM option 
* update title if necessary.

### Options: 
* Copied from the template input file if exists.
* set / update simulation parameters.

### Climatology:
* Copied from the template input file if exists.
* set / update climatology parameters

### Hydrology:
#### Rain Gages: 
QGEP_SWMM creates one raingage for each subcatchment. 

By default:
* Time serie: Each raingage is related to a default rain time serie called `default_qgep_raingage_timeserie`. The time serie must be created and the value Series Name update accordingly.
* Other parameters have default SWMM values

#### Aquifers:
QGEP_SWMM creates an aquifer for each qgep aquifiers.

By default:
* An aquifer is created for each qgep aquifiers
* The bottom elevation is set to the minimal_groundwater_level
* The water table elevation is set to the average_groundwater_level
* Other parameters have default SWMM values

#### Subcatchment:
QGEP_SWMM creates a subcatchment for each QGEP catchment area
By default:
* a subcatchment is created for each QGEP catchment area
* it is linked to a rain gage. 
* The width is computed from the mean of the minimal / maximal distance between the outlet and the catchment area contour. If the outlet is unknow the centroid is used rather thant the outlet.
* The coverages (attribute land uses) are computed from the intersection between the catchment area and the planning zone
* Other parameters have default SWMM values

The subcatchment can be linked to an aquifer via the groundwater attribute.


#### Snow Packs
* Copied from the template input file if exists.

#### Unit hydrographs
* Copied from the template input file if exists.

#### LID Controls
* Copied from the template input file if exists.

### Hydraulics

#### Junctions
* QGEP_SWMM creates a junction for each QGEP manhole and some kind of special structures.

* See `vw_swmm_junctions.sql` for details.

#### Outfalls
* QGEP_SWMM creates an outfall for each QGEP discharge_point.

* See `vw_swmm_outfalls.sql` for details.

#### Dividers
* Are not created from QGEP objects.

* Copied from the template input file if exists.

#### Storage Units
* QGEP_SWMM creates a storage for some kind of QGEP infiltration installations and some kind of QGEP special structures.

* See `vw_swmm_storages.sql` for details.

#### Conduits
* QGEP_SWMM creates a conduit for each QGEP reach.

* See `vw_swmm_conduits.sql` for details.

#### Pumps
* QGEP_SWMM creates a pump for each QGEP pump.

* See `vw_swmm_pumps.sql` for details.

#### Orifices
* Are not created from QGEP objects.

* Copied from the template input file if exists.

#### Weirs
* Are not created from QGEP objects.

* Copied from the template input file if exists.

#### Outlets
* Are not created from QGEP objects.

* Copied from the template input file if exists.

#### Transects
* Are not created from QGEP objects.

* Copied from the template input file if exists.

#### Controls
* Are not created from QGEP objects.

* Copied from the template input file if exists.

### Quality

#### Land uses
* QGEP_SWMM creates a land use for each QGEP planning zone kind.

#### Pollutants
* Are not created from QGEP objects.

* Copied from the template input file if exists.

### Curves
* Are not created from QGEP objects.

* Copied from the template input file if exists.

### Time series
* Are not created from QGEP objects.

* Copied from the template input file if exists.

### Time patterns
* Are not created from QGEP objects.

* Copied from the template input file if exists.

### Labels
* Are not created from QGEP objects.

* Copied from the template input file if exists.

## Run a simulation
Use the *lightning* button

### Solve running errors
[Errors explanation](https://swmm5.org/2016/09/05/swmm-5-1-and-infoswmm-error-and-warning-messages/)

`ERROR 211: invalid number -XXX at line XXX of [JUNC] section:`

A negative number is provided for the depth => change the value in QGEP or in the .inp file.

## Run current state simulation

### Minimal parameters to be set
! TO BE CHECKED!

* `Time series` Create a time serie for the rain (default_qgep_raingage_timeserie) / the time serie have to be linked to the raingages `Hydrology > Rain Gages` (which are linked to the subcatchments)

* `Hydrology > Subcatchment`: Set percent of of impervious area and infiltration parameters


### Optional parameters
* `Climatology > Evaporation`

## Run aimed state simulation
* Copy the inp file used for the previous simulation

### Impervious areas increase
Hydrology > Subcatchements > % Imperv


## Run variants (network is modified)
* New links and new nodes are created directly in SWMM GUI
